#!/bin/bash
# Docker CI/CD Pipeline for YouTube Demo
set -e

echo "Starting Docker CI/CD Pipeline Demo"
echo "===================================="

# Variables
PROJECT_NAME="my-testing-app"
VERSION="1.0.0"
TIMESTAMP=$(date +%Y%m%d_%H%M%S)

echo "[1/4] Building application..."
mvn clean package -DskipTests

echo "[2/4] Building Docker image..."
docker build -t "${PROJECT_NAME}:${VERSION}-${TIMESTAMP}" .
docker tag "${PROJECT_NAME}:${VERSION}-${TIMESTAMP}" "${PROJECT_NAME}:latest"

echo "[3/4] Running Docker container..."
docker run -d -p 8080:8080 --name="${PROJECT_NAME}-demo" "${PROJECT_NAME}:latest"

echo "[4/4] Verifying deployment..."
sleep 5
if curl -f http://localhost:8080/my-app/ > /dev/null 2>&1; then
    echo "✓ Application is running!"
    docker logs "${PROJECT_NAME}-demo"
else
    echo "✗ Application failed to start"
    exit 1
fi

echo "===================================="
echo "Docker CI/CD Pipeline Demo Complete!"
